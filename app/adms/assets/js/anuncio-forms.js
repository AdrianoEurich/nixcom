/**
 * AN√öNCIO FORMS - Manipula√ß√£o de formul√°rios
 * Vers√£o: 3.0 (Modular Simples)
 */

console.log('üìù AN√öNCIO FORMS carregado');

window.AnuncioForms = {
    init: function(form, formMode, userRole, userPlanType) {
        console.log("‚úÖ AN√öNCIO FORMS: Inicializando formul√°rios");
        console.log("üîç DEBUG: formMode:", formMode, "| userRole:", userRole, "| userPlanType:", userPlanType);
        this.setupFormSubmission(form, formMode, userRole, userPlanType);
    },

    setupFormSubmission: function(form, formMode, userRole, userPlanType) {
        if (form && !form.dataset.submitListenerAdded) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('üéØ DEBUG JS: Event listener de submit chamado!');
            console.log('INFO JS: submitAnuncioForm - Formul√°rio submetido.');

            // Validar formul√°rio antes de enviar
            if (window.AnuncioValidation && !window.AnuncioValidation.validateForm()) {
                console.log('‚ùå AN√öNCIO FORMS: Formul√°rio inv√°lido, cancelando envio');
                return;
            }

            const submitButton = form.querySelector('button[type="submit"]');
            const originalButtonHTML = window.activateButtonLoading(submitButton, 'Salvando...');

            window.showLoadingModal();

            const formData = new FormData(form);
            formData.append('form_mode', formMode);
            formData.append('user_plan_type', userPlanType);

            // Debug: Log dos dados do formul√°rio
            console.log('üîç AN√öNCIO FORMS: Dados do formul√°rio:');
            for (let [key, value] of formData.entries()) {
                console.log(`  ${key}:`, value);
            }
            
            // Debug espec√≠fico para arquivos
            console.log('üîç AN√öNCIO FORMS: Verificando arquivos espec√≠ficos:');
            console.log('  confirmation_video:', formData.get('confirmation_video'));
            console.log('  foto_capa:', formData.get('foto_capa'));
            console.log('  fotos_galeria_upload_0:', formData.get('fotos_galeria_upload_0'));
            console.log('  fotos_galeria_upload_1:', formData.get('fotos_galeria_upload_1'));
            
            // Verificar se os arquivos s√£o realmente File objects
            const confirmationVideo = formData.get('confirmation_video');
            const fotoCapa = formData.get('foto_capa');
            const galeria0 = formData.get('fotos_galeria_upload_0');
            
            console.log('üîç AN√öNCIO FORMS: Tipos dos arquivos:');
            console.log('  confirmation_video √© File?', confirmationVideo instanceof File);
            console.log('  foto_capa √© File?', fotoCapa instanceof File);
            console.log('  galeria0 √© File?', galeria0 instanceof File);
            
            if (confirmationVideo instanceof File) {
                console.log('  confirmation_video size:', confirmationVideo.size, 'type:', confirmationVideo.type);
            }
            if (fotoCapa instanceof File) {
                console.log('  foto_capa size:', fotoCapa.size, 'type:', fotoCapa.type);
            }
            if (galeria0 instanceof File) {
                console.log('  galeria0 size:', galeria0.size, 'type:', galeria0.type);
            }
            
            // Debug espec√≠fico para arquivos
            console.log('üîç AN√öNCIO FORMS: Verificando arquivos espec√≠ficos:');
            console.log('  confirmation_video:', formData.get('confirmation_video'));
            console.log('  foto_capa:', formData.get('foto_capa'));
            console.log('  fotos_galeria_upload_0:', formData.get('fotos_galeria_upload_0'));
            console.log('  fotos_galeria_upload_1:', formData.get('fotos_galeria_upload_1'));
            console.log('  fotos_galeria_upload_2:', formData.get('fotos_galeria_upload_2'));

                try {
                    const response = await fetch(form.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });

                    const result = await response.json();
                console.log('üîç DEBUG JS: Resposta do servidor:', result);
                    
                    // Debug: Log da resposta do servidor
                    console.log('üîç AN√öNCIO FORMS: Resposta do servidor:', result);
                    if (result.errors) {
                        console.log('üîç AN√öNCIO FORMS: Erros espec√≠ficos:', result.errors);
                        console.log('üîç AN√öNCIO FORMS: Detalhes dos erros:', JSON.stringify(result.errors, null, 2));
                    }
                    if (result.debug) {
                        console.log('üîç AN√öNCIO FORMS: Debug do servidor:', result.debug);
                    }
                    if (result.message) {
                        console.log('üîç AN√öNCIO FORMS: Mensagem do servidor:', result.message);
                    }

                    setTimeout(() => {
                        window.hideLoadingModal();
                        window.deactivateButtonLoading(submitButton, originalButtonHTML);

                        if (result.success) {
                            console.log('üéâ DEBUG JS: Sucesso detectado! Dados:', result);
                            
                            // Verificar se showFeedbackModal existe e est√° funcionando
                            if (typeof window.showFeedbackModal === 'function') {
                                try {
                                    console.log('INFO JS: Tentando mostrar modal de sucesso...');
                                    window.showFeedbackModal('success', result.message, 'Sucesso!', 2000);
                                    console.log('INFO JS: Modal de sucesso exibido com sucesso');
                                } catch (error) {
                                    console.error('ERRO JS: Erro ao mostrar modal de sucesso:', error);
                                    alert('Sucesso: ' + result.message);
                                }
                            } else {
                                console.warn('AVISO JS: showFeedbackModal n√£o est√° dispon√≠vel, usando alert');
                                alert('Sucesso: ' + result.message);
                            }
                            document.body.dataset.hasAnuncio = result.has_anuncio ? 'true' : 'false';
                            document.body.dataset.anuncioStatus = result.anuncio_status || 'not_found';
                            document.body.dataset.anuncioId = result.anuncio_id || '';
                            window.updateAnuncioSidebarLinks();

                            if (form.dataset.formMode === 'create' && result.anuncio_id) {
                                setTimeout(() => {
                                    window.location.href = `${window.URLADM}dashboard`;
                                }, 2000);
                            }
                        } else {
                            let errorMessage = result.message || 'Ocorreu um erro ao processar o an√∫ncio.';
                            if (result.errors) {
                                for (const field in result.errors) {
                                    const feedbackElement = document.getElementById(`${field}-feedback`);
                                    if (feedbackElement) {
                                        feedbackElement.textContent = result.errors[field];
                                        feedbackElement.style.display = 'block';
                                    } else {
                                        errorMessage += `\n- ${result.errors[field]}`;
                                    }
                                }
                            }
                            // Verificar se showFeedbackModal existe e est√° funcionando
                            if (typeof window.showFeedbackModal === 'function') {
                                try {
                                    window.showFeedbackModal('error', errorMessage, 'Erro!');
                                } catch (error) {
                                    console.error('Erro ao mostrar modal de erro:', error);
                                    alert('Erro: ' + errorMessage);
                                }
                            } else {
                                alert('Erro: ' + errorMessage);
                            }
                        }
                    }, 2000);
                } catch (error) {
                    console.error('ERRO JS: Erro na requisi√ß√£o AJAX:', error);
                    setTimeout(() => {
                        window.hideLoadingModal();
                        window.deactivateButtonLoading(submitButton, originalButtonHTML);
                        // Verificar se showFeedbackModal existe e est√° funcionando
                        if (typeof window.showFeedbackModal === 'function') {
                            try {
                                window.showFeedbackModal('error', 'Erro de conex√£o. Por favor, tente novamente.', 'Erro de Rede');
                            } catch (error) {
                                console.error('Erro ao mostrar modal de conex√£o:', error);
                                alert('Erro de conex√£o. Por favor, tente novamente.');
                            }
                        } else {
                            alert('Erro de conex√£o. Por favor, tente novamente.');
                        }
                    }, 2000);
                }
            });
            form.dataset.submitListenerAdded = 'true';
            console.log("‚úÖ AN√öNCIO FORMS: Listener de submiss√£o configurado");
        }
    },

    populateFormFields: function(anuncioData, currentFormMode) {
        console.log("üîß AN√öNCIO FORMS: Preenchendo campos do formul√°rio");
        console.log("üîç DEBUG: anuncioData:", anuncioData, "| formMode:", currentFormMode);

        if (!anuncioData) {
            console.log("‚ö†Ô∏è AN√öNCIO FORMS: Nenhum dado de an√∫ncio fornecido");
            return;
        }

        // Preencher campos b√°sicos
        const fields = [
            'service_name', 'age', 'phone_number', 'description', 'gender', 
            'nationality', 'ethnicity', 'eye_color', 'neighborhood_name',
            'state_id', 'city_id'
        ];

        fields.forEach(fieldName => {
            const field = document.getElementById(fieldName);
            if (field && anuncioData[fieldName]) {
                field.value = anuncioData[fieldName];
                console.log(`DEBUG JS: Campo ${fieldName} preenchido com:`, anuncioData[fieldName]);
            }
        });

        // Preencher altura e peso
        if (anuncioData.height_m) {
            const heightField = document.getElementById('height_m');
            if (heightField) {
                heightField.value = anuncioData.height_m;
                console.log(`DEBUG JS: Campo height_m preenchido com: ${anuncioData.height_m} (anuncioData original: ${anuncioData.height_m})`);
            }
        }

        if (anuncioData.weight_kg) {
            const weightField = document.getElementById('weight_kg');
            if (weightField) {
                weightField.value = anuncioData.weight_kg;
                console.log(`DEBUG JS: Campo weight_kg preenchido com: ${anuncioData.weight_kg} (anuncioData: ${anuncioData.weight_kg})`);
            }
        }

        // Preencher pre√ßos
        const priceFields = ['price_15min', 'price_30min', 'price_1h'];
        priceFields.forEach(priceField => {
            const field = document.getElementById(priceField);
            if (field && anuncioData[priceField]) {
                // O valor vem do PHP j√° formatado com v√≠rgula (ex: "15,00")
                // Precisamos converter para o formato que o inputmask espera
                // Converter do formato brasileiro para float corretamente
                let cleanValue;
                if (anuncioData[priceField].includes(',')) {
                    // Se tem v√≠rgula, √© o separador decimal brasileiro
                    const parts = anuncioData[priceField].split(',');
                    const integerPart = parts[0].replace(/\./g, ''); // Remove pontos de milhares
                    const decimalPart = parts[1] || '00';
                    cleanValue = integerPart + '.' + decimalPart;
                } else {
                    // Se n√£o tem v√≠rgula, pode ter pontos de milhares
                    cleanValue = anuncioData[priceField].replace(/\./g, '');
                }
                
                const numericValue = parseFloat(cleanValue);
                if (!isNaN(numericValue)) {
                    // Limpar o campo antes de definir o valor
                    field.value = '';
                    // Definir o valor num√©rico puro para o inputmask processar
                    field.value = numericValue.toString();
                    console.log(`DEBUG JS: Campo ${priceField} - anuncioData: ${anuncioData[priceField]}, cleanValue: ${cleanValue}, numericValue: ${numericValue}`);
                } else {
                    console.warn(`DEBUG JS: Valor inv√°lido para ${priceField}: ${anuncioData[priceField]}`);
                }
            }
        });

        // Preencher checkboxes
        const checkboxGroups = [
            'aparencia', 'idiomas', 'locais_atendimento', 'formas_pagamento', 'servicos'
        ];

        checkboxGroups.forEach(groupName => {
            const checkboxes = document.querySelectorAll(`input[name="${groupName}[]"]`);
            const existingValues = anuncioData[groupName] || [];
            
            checkboxes.forEach(checkbox => {
                if (existingValues.includes(checkbox.value)) {
                    checkbox.checked = true;
                }
            });
            
            console.log(`DEBUG JS: Checkboxes para ${groupName} preenchidos. Valores existentes:`, existingValues);
        });

        // Preencher ID do an√∫ncio se estiver editando
        if (currentFormMode === 'edit' && anuncioData.id) {
            const anuncioIdField = document.getElementById('anuncio_id');
            if (anuncioIdField) {
                anuncioIdField.value = anuncioData.id;
                console.log(`DEBUG JS: Campo anuncio_id preenchido com: ${anuncioData.id}`);
            }
        }

        console.log("‚úÖ AN√öNCIO FORMS: Campos do formul√°rio preenchidos");
    }
};

console.log("‚úÖ AN√öNCIO FORMS: M√≥dulo carregado e pronto");
