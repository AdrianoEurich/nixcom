// anuncio-admin.js - M√≥dulo para funcionalidades de administrador
console.log('üëë AN√öNCIO ADMIN carregado');

/**
 * Habilita ou desabilita um bot√£o baseado no estado
 * @param {HTMLElement} button - O elemento do bot√£o
 * @param {boolean} enabled - Se o bot√£o deve estar habilitado
 */
function toggleButtonState(button, enabled) {
    if (!button) return;
    
    if (enabled) {
        button.disabled = false;
        button.classList.remove('disabled');
        button.style.opacity = '1';
        button.style.cursor = 'pointer';
    } else {
        button.disabled = true;
        button.classList.add('disabled');
        button.style.opacity = '0.5';
        button.style.cursor = 'not-allowed';
    }
}

/**
 * Configura os event listeners para os bot√µes de a√ß√£o do administrador (Aprovar, Reprovar, Excluir, Ativar, Pausar, Visualizar, Excluir Conta).
 * @param {string} anuncioId O ID do an√∫ncio.
 * @param {string} anuncianteUserId O ID do usu√°rio anunciante.
 * @param {string} currentAnuncioStatus O status atual do an√∫ncio (ex: 'pending', 'approved', 'active', 'pausado', 'rejected').
 */
function setupAdminActionButtons(anuncioId, anuncianteUserId, currentAnuncioStatus) {
    console.log('INFO JS: setupAdminActionButtons - Configurando bot√µes de a√ß√£o do administrador.');
    console.log(`DEBUG JS: setupAdminActionButtons - An√∫ncio ID: ${anuncioId}, Anunciante User ID: ${anuncianteUserId}, Status: ${currentAnuncioStatus}`);

    const btnApprove = document.getElementById('btnApproveAnuncio');
    const btnReject = document.getElementById('btnRejectAnuncio');
    const btnDelete = document.getElementById('btnDeleteAnuncio');
    const btnActivate = document.getElementById('btnActivateAnuncio');
    const btnDeactivate = document.getElementById('btnDeactivateAnuncio');
    const btnVisualizar = document.getElementById('btnVisualizarAnuncio');
    const btnDeleteAccount = document.getElementById('btnDeleteAccount');

    // Remove listeners antigos para evitar duplica√ß√£o em navega√ß√µes SPA
    if (btnApprove && btnApprove._clickHandler) btnApprove.removeEventListener('click', btnApprove._clickHandler);
    if (btnReject && btnReject._clickHandler) btnReject.removeEventListener('click', btnReject._clickHandler);
    if (btnDelete && btnDelete._clickHandler) btnDelete.removeEventListener('click', btnDelete._clickHandler);
    if (btnActivate && btnActivate._clickHandler) btnActivate.removeEventListener('click', btnActivate._clickHandler);
    if (btnDeactivate && btnDeactivate._clickHandler) btnDeactivate.removeEventListener('click', btnDeactivate._clickHandler);
    if (btnVisualizar && btnVisualizar._clickHandler) btnVisualizar.removeEventListener('click', btnVisualizar._clickHandler);
    if (btnDeleteAccount && btnDeleteAccount._clickHandler) btnDeleteAccount.removeEventListener('click', btnDeleteAccount._clickHandler);

    // L√≥gica para habilitar/desabilitar e adicionar listeners
    if (btnApprove) {
        const canApprove = currentAnuncioStatus === 'pending' || currentAnuncioStatus === 'rejected';
        toggleButtonState(btnApprove, canApprove);
        if (canApprove) {
            const handler = function() {
                window.showConfirmModal(
                    'Tem certeza que deseja APROVAR este an√∫ncio? Ele ficar√° vis√≠vel publicamente.',
                    'Aprovar An√∫ncio'
                ).then(result => {
                    if (result) {
                        performAdminAction('approve', anuncioId, anuncianteUserId);
                    }
                });
            };
            btnApprove.addEventListener('click', handler);
            btnApprove._clickHandler = handler;
        }
    }

    if (btnReject) {
        const canReject = currentAnuncioStatus === 'pending' || currentAnuncioStatus === 'approved' || currentAnuncioStatus === 'active';
        toggleButtonState(btnReject, canReject);
        if (canReject) {
            const handler = function() {
                window.showConfirmModal(
                    'Tem certeza que deseja REPROVAR este an√∫ncio? Ele n√£o ficar√° vis√≠vel publicamente.',
                    'Reprovar An√∫ncio'
                ).then(result => {
                    if (result) {
                        performAdminAction('reject', anuncioId, anuncianteUserId);
                    }
                });
            };
            btnReject.addEventListener('click', handler);
            btnReject._clickHandler = handler;
        }
    }

    if (btnActivate) {
        const canActivate = currentAnuncioStatus === 'pausado';
        toggleButtonState(btnActivate, canActivate);
        if (canActivate) {
            const handler = function() {
                window.showConfirmModal(
                    'Tem certeza que deseja ATIVAR este an√∫ncio? Ele ficar√° vis√≠vel publicamente.',
                    'Ativar An√∫ncio'
                ).then(result => {
                    if (result) {
                        performAdminAction('activate', anuncioId, anuncianteUserId);
                    }
                });
            };
            btnActivate.addEventListener('click', handler);
            btnActivate._clickHandler = handler;
        }
    }

    if (btnDeactivate) {
        const canDeactivate = currentAnuncioStatus === 'active';
        toggleButtonState(btnDeactivate, canDeactivate);
        if (canDeactivate) {
            const handler = function() {
                window.showConfirmModal(
                    'Tem certeza que deseja PAUSAR este an√∫ncio? Ele n√£o ficar√° vis√≠vel publicamente.',
                    'Pausar An√∫ncio'
                ).then(result => {
                    if (result) {
                        performAdminAction('deactivate', anuncioId, anuncianteUserId);
                    }
                });
            };
            btnDeactivate.addEventListener('click', handler);
            btnDeactivate._clickHandler = handler;
        }
    }

    // L√≥gica para o bot√£o "Visualizar An√∫ncio" para o administrador
    if (btnVisualizar) {
        toggleButtonState(btnVisualizar, true);
        btnVisualizar.href = `${window.URLADM}anuncio/visualizarAnuncio?id=${anuncioId}`;
        btnVisualizar.dataset.spa = 'true';
        console.log(`DEBUG JS: btnVisualizarAnuncio configurado para admin. Href: ${btnVisualizar.href}`);
    }

    // L√≥gica para o bot√£o "Excluir Conta" do usu√°rio (admin)
    if (btnDeleteAccount) {
        const handler = function (event) {
            event.preventDefault();
            const anuncianteUserIdFinal = btnDeleteAccount.dataset.anuncianteUserId || anuncianteUserId;

            if (typeof window.showConfirmModal === 'function') {
                window.showConfirmModal(
                    "Tem certeza que deseja excluir esta conta? Todos os an√∫ncios deste usu√°rio ser√£o removidos. Esta a√ß√£o √© irrevers√≠vel.",
                    'Excluir Conta do Usu√°rio',
                    'danger'
                ).then(confirmed => {
                    if (confirmed) {
                        console.log(`DEBUG JS: Usu√°rio confirmou exclus√£o da conta. User ID: ${anuncianteUserIdFinal}`);
                        
                        window.showLoadingModal();
                        
                        fetch(window.URLADM + 'perfil/deleteAccount', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: JSON.stringify({
                                user_id: anuncianteUserIdFinal,
                                admin_action: true
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            console.log('DEBUG JS: Resposta da exclus√£o da conta:', data);
                            
                            setTimeout(() => {
                                window.hideLoadingModal();
                                
                                if (data.success) {
                                    window.showFeedbackModal('success', 'Conta exclu√≠da com sucesso!', 'Exclus√£o de Conta');
                                    setTimeout(() => {
                                        const target = (data.redirect_url && typeof data.redirect_url === 'string') ? data.redirect_url : (window.URLADM + 'dashboard');
                                        window.location.href = target;
                                    }, 1200);
                                } else {
                                    window.showFeedbackModal('error', data.message || 'Erro ao excluir conta.', 'Erro na Exclus√£o');
                                }
                            }, 300);
                        })
                        .catch(error => {
                            console.error('ERROR JS: Erro na exclus√£o da conta:', error);
                            
                            setTimeout(() => {
                                window.hideLoadingModal();
                                window.showFeedbackModal('error', 'Erro interno. Tente novamente.', 'Erro na Exclus√£o');
                            }, 300);
                        });
                    }
                });
            }
        };
        btnDeleteAccount.addEventListener('click', handler);
        btnDeleteAccount._clickHandler = handler;
    }
}

/**
 * Realiza a a√ß√£o do administrador via AJAX.
 * @param {string} action A a√ß√£o a ser realizada ('approve', 'reject', 'activate', 'deactivate', 'delete').
 * @param {string} anuncioId O ID do an√∫ncio.
 * @param {string} anuncianteUserId O ID do usu√°rio anunciante.
 */
async function performAdminAction(action, anuncioId, anuncianteUserId) {
    console.log(`INFO JS: performAdminAction - Executando a√ß√£o: ${action} para an√∫ncio ID: ${anuncioId}`);

    window.showLoadingModal();

    try {
        const response = await fetch(`${window.URLADM}anuncio/adminAction`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                action: action,
                anuncio_id: anuncioId,
                anunciante_user_id: anuncianteUserId
            })
        });

        const data = await response.json();
        console.log(`DEBUG JS: performAdminAction - Resposta da a√ß√£o ${action}:`, data);

        setTimeout(() => {
            window.hideLoadingModal();

            if (data.success) {
                window.showFeedbackModal('success', data.message || 'A√ß√£o realizada com sucesso!', 'Sucesso');
                
                // Atualizar bot√µes de administrador dinamicamente se o novo status foi fornecido
                if (data.new_status && window.updateAdminButtonsAfterAction) {
                    console.log('üîÑ AN√öNCIO ADMIN: Atualizando bot√µes com novo status:', data.new_status);
                    window.updateAdminButtonsAfterAction(data.new_status, anuncioId, anuncianteUserId);
                } else if (!data.new_status) {
                    console.warn('‚ö†Ô∏è AN√öNCIO ADMIN: new_status vazio na resposta. Tentando determinar status baseado na a√ß√£o...');
                    // Tentar determinar o status baseado na a√ß√£o
                    let expectedStatus = '';
                    if (action === 'deactivate') expectedStatus = 'pausado';
                    else if (action === 'activate') expectedStatus = 'active';
                    else if (action === 'approve') expectedStatus = 'active';
                    else if (action === 'reject') expectedStatus = 'rejected';
                    
                    if (expectedStatus && window.updateAdminButtonsAfterAction) {
                        console.log('üîÑ AN√öNCIO ADMIN: Usando status esperado:', expectedStatus);
                        window.updateAdminButtonsAfterAction(expectedStatus, anuncioId, anuncianteUserId);
                    }
                }
                
                // Recarregar dados da dashboard se estivermos na p√°gina de dashboard
                if (window.location.pathname.includes('/dashboard') || window.location.pathname.includes('/adms/dashboard')) {
                    console.log('üîÑ AN√öNCIO ADMIN: Recarregando dados da dashboard...');
                    setTimeout(() => {
                        if (window.loadAnunciosData) {
                            window.loadAnunciosData();
                        } else if (window.initializeAnunciosListPage) {
                            window.initializeAnunciosListPage(window.location.href);
                        }
                    }, 1000);
                }
            } else {
                window.showFeedbackModal('error', data.message || 'Erro ao realizar a√ß√£o.', 'Erro');
            }
        }, 3000);

    } catch (error) {
        console.error(`ERROR JS: Erro na a√ß√£o ${action}:`, error);
        
        setTimeout(() => {
            window.hideLoadingModal();
            window.showFeedbackModal('error', 'Erro interno. Tente novamente.', 'Erro');
        }, 3000);
    }
}

// Fun√ß√£o para atualizar bot√µes de administrador ap√≥s uma a√ß√£o
function updateAdminButtonsAfterAction(newStatus, anuncioId, anuncianteUserId) {
    console.log('üîÑ AN√öNCIO ADMIN: Atualizando bot√µes ap√≥s a√ß√£o. Novo status:', newStatus);
    console.log('üîÑ AN√öNCIO ADMIN: Par√¢metros:', { newStatus, anuncioId, anuncianteUserId });
    
    // Remover bot√µes existentes
    const adminButtonsContainer = document.querySelector('.d-flex.flex-column.flex-sm-row.justify-content-center.gap-3');
    console.log('üîÑ AN√öNCIO ADMIN: Container encontrado:', !!adminButtonsContainer);
    console.log('üîÑ AN√öNCIO ADMIN: Container HTML:', adminButtonsContainer?.outerHTML);
    
    if (adminButtonsContainer) {
        // Remover bot√µes din√¢micos (pausar/ativar)
        const dynamicButtons = adminButtonsContainer.querySelectorAll('#btnDeactivateAnuncio, #btnActivateAnuncio');
        dynamicButtons.forEach(btn => btn.remove());
        
        // Adicionar bot√£o apropriado baseado no novo status
        if (newStatus === 'active') {
            const pauseButton = document.createElement('button');
            pauseButton.type = 'button';
            pauseButton.className = 'btn btn-warning btn-lg';
            pauseButton.id = 'btnDeactivateAnuncio';
            pauseButton.setAttribute('data-anuncio-id', anuncioId);
            pauseButton.setAttribute('data-anunciante-user-id', anuncianteUserId);
            pauseButton.textContent = 'Pausar An√∫ncio';
            
            // Adicionar event listener
            pauseButton.addEventListener('click', function() {
                window.showConfirmModal(
                    'Tem certeza que deseja PAUSAR este an√∫ncio? Ele ficar√° oculto do p√∫blico.',
                    'Pausar An√∫ncio'
                ).then(result => {
                    if (result) {
                        performAdminAction('deactivate', anuncioId, anuncianteUserId);
                    }
                });
            });
            
            adminButtonsContainer.appendChild(pauseButton);
            console.log('‚úÖ AN√öNCIO ADMIN: Bot√£o "Pausar" adicionado');
            
        } else if (newStatus === 'pausado') {
            const activateButton = document.createElement('button');
            activateButton.type = 'button';
            activateButton.className = 'btn btn-info btn-lg';
            activateButton.id = 'btnActivateAnuncio';
            activateButton.setAttribute('data-anuncio-id', anuncioId);
            activateButton.setAttribute('data-anunciante-user-id', anuncianteUserId);
            activateButton.textContent = 'Ativar An√∫ncio';
            
            // Adicionar event listener
            activateButton.addEventListener('click', function() {
                window.showConfirmModal(
                    'Tem certeza que deseja ATIVAR este an√∫ncio? Ele ficar√° vis√≠vel publicamente.',
                    'Ativar An√∫ncio'
                ).then(result => {
                    if (result) {
                        performAdminAction('activate', anuncioId, anuncianteUserId);
                    }
                });
            });
            
            adminButtonsContainer.appendChild(activateButton);
            console.log('‚úÖ AN√öNCIO ADMIN: Bot√£o "Ativar" adicionado');
        }
    }
}

// Expor fun√ß√µes globalmente
window.setupAdminActionButtons = setupAdminActionButtons;
window.performAdminAction = performAdminAction;
window.toggleButtonState = toggleButtonState;
window.updateAdminButtonsAfterAction = updateAdminButtonsAfterAction;

console.log('‚úÖ AN√öNCIO ADMIN: M√≥dulo carregado e pronto');
